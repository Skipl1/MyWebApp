@model dynamic 
@using System.Linq 
@using Microsoft.AspNetCore.Mvc.Rendering

@{
    ViewData["Title"] = $"–£—á–µ–±–Ω—ã–π –ø–ª–∞–Ω: {Model.Specialty.Name}";
    var disciplinesBySemester = (IEnumerable<dynamic>)Model.DisciplinesBySemester;
    
    // –î–∞–Ω–Ω—ã–µ –¥–ª—è —Ñ–æ—Ä–º—ã
    var allDisciplines = ViewData["AllDisciplines"] as List<SelectListItem>;
    var allCertTypes = ViewData["AllCertificationTypes"] as List<SelectListItem>;
    var specialtyId = (int)ViewData["SpecialtyId"]; 
    
    var hasDisciplines = disciplinesBySemester.Any(); 
}

@* –ü–æ–¥–∫–ª—é—á–∞–µ–º –≤–∞—à–∏ —Å—Ç–∏–ª–∏ *@
<link rel="stylesheet" href="~/css/site.css" asp-append-version="true" />

<div class="container program-container">
    
    @* === 1. –ö–ù–û–ü–ö–ê –ù–ê–ó–ê–î === *@
    <a asp-controller="Specialties" asp-action="Index" class="back-button">
        <span class="back-icon">‚Üê</span> –ö —Å–ø–µ—Ü–∏–∞–ª—å–Ω–æ—Å—Ç—è–º
    </a>

    @* === 2. –ó–ê–ì–û–õ–û–í–û–ö –°–¢–†–ê–ù–ò–¶–´ === *@
    <div style="text-align: center; margin-bottom: 30px;">
        <h1 style="margin-bottom: 5px;">@Model.Specialty.Name</h1>
        <p style="color: var(--text-muted); font-size: 1.1rem; font-weight: 500;">
            –ù–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ: <span style="color: var(--text-main);">@Model.Specialty.Direction</span>
        </p>

        @* –ö–ù–û–ü–ö–ê –°–ö–ê–ß–ê–¢–¨ *@
        @if (hasDisciplines)
        {
            <div style="margin-top: 20px;">
                <a asp-action="Download" asp-route-specialtyId="@Model.Specialty.Id" class="btn">
                    ‚¨áÔ∏è –°–∫–∞—á–∞—Ç—å PDF
                </a>
            </div>
        }
        else
        {
             <div class="empty-message" style="text-align: center; color: var(--text-muted); padding: 10px 0;">
                –î–ª—è —Å–∫–∞—á–∏–≤–∞–Ω–∏—è –ø–ª–∞–Ω–∞ –¥–æ–±–∞–≤—å—Ç–µ –¥–∏—Å—Ü–∏–ø–ª–∏–Ω—ã.
            </div>
        }
    </div>

    @* === 3. –§–û–†–ú–ê –î–û–ë–ê–í–õ–ï–ù–ò–Ø (ADMIN) - –†–ê–°–ö–†–´–í–ê–Æ–©–ê–Ø–°–Ø, –°–¢–ò–õ–ò–ó–û–í–ê–ù–ù–ê–Ø –ü–û–î –ö–ù–û–ü–ö–£ === *@
    @if (User.IsInRole("admin"))
    {
        @* –û—Å–Ω–æ–≤–Ω–æ–π div –¥–ª—è —Ü–µ–Ω—Ç—Ä–∏—Ä–æ–≤–∞–Ω–∏—è –∏ –æ—Ç—Å—Ç—É–ø–∞ *@
        <div style="margin-bottom: 40px; text-align: center;">
            @* –ò–ó–ú–ï–ù–ï–ù–ò–ï: –£–±—Ä–∞–ª–∏ border, —á—Ç–æ–±—ã –Ω–µ –∫–æ–Ω—Ñ–ª–∏–∫—Ç–æ–≤–∞–ª —Å —Ä–∞–º–∫–æ–π –∫–Ω–æ–ø–∫–∏ *@
            <details style="display: inline-block; text-align: left; width: 100%; max-width: 800px; /* –£–ë–†–ê–ù: border: 1px solid var(--border-light); */ border-radius: var(--radius); overflow: hidden;">
                
                @* –ó–∞–≥–æ–ª–æ–≤–æ–∫, —Å—Ç–∏–ª–∏–∑–æ–≤–∞–Ω–Ω—ã–π –ø–æ–¥ –∫–Ω–æ–ø–∫—É .btn *@
                <summary class="btn" 
                        style="cursor: pointer; 
                                list-style: none; 
                                padding: 0.6rem 1.2rem; 
                                display: flex; 
                                justify-content: center; 
                                align-items: center; 
                                width: 100%; 
                                /* –î–û–ë–ê–í–õ–ï–ù–û: –°–∫—Ä—É–≥–ª–µ–Ω–∏–µ —É–≥–ª–æ–≤ –¥–ª—è summary, —á—Ç–æ–±—ã –∑–∞–∫—Ä—ã—Ç–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ –≤—ã–≥–ª—è–¥–µ–ª–æ –∫–∞–∫ —Ü–µ–ª–∞—è –∫–Ω–æ–ø–∫–∞ */
                                border-radius: var(--radius); 
                                font-size: 0.95rem; 
                                font-weight: 600;">
                    <span>–î–æ–±–∞–≤–∏—Ç—å –¥–∏—Å—Ü–∏–ø–ª–∏–Ω—É</span>
                </summary>
                
                @* –°–æ–¥–µ—Ä–∂–∏–º–æ–µ —Ñ–æ—Ä–º—ã *@
                <div style="padding: 20px; background-color: var(--bg-card); border-top: 1px solid var(--border-light);"> 
                    @* –î–û–ë–ê–í–õ–ï–ù–û: –õ–∏–Ω–∏—è —Ä–∞–∑–¥–µ–ª–µ–Ω–∏—è –º–µ–∂–¥—É –∫–Ω–æ–ø–∫–æ–π –∏ —Ñ–æ—Ä–º–æ–π, –∫–æ–≥–¥–∞ –æ–Ω–∞ –æ—Ç–∫—Ä—ã—Ç–∞ *@
                    <form asp-action="Add" asp-controller="Curriculum" method="post">
                        <input type="hidden" name="SpecialtyId" value="@specialtyId" />

                        <div class="input-group" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px;">
                            @* –î–∏—Å—Ü–∏–ø–ª–∏–Ω–∞ *@
                            <div>
                                <label class="info-label">–î–∏—Å—Ü–∏–ø–ª–∏–Ω–∞</label>
                                <select name="DisciplineId" class="form-control" required>
                                    <option value="">-- –í—ã–±–µ—Ä–∏—Ç–µ --</option>
                                    @foreach (var item in allDisciplines)
                                    {
                                        <option value="@item.Value">@item.Text</option>
                                    }
                                </select>
                            </div>

                            @* –°–µ–º–µ—Å—Ç—Ä *@
                            <div>
                                <label class="info-label">–°–µ–º–µ—Å—Ç—Ä</label>
                                <input name="Semester" type="number" min="1" max="12" class="form-control" value="1" required />
                            </div>

                            @* –ê—Ç—Ç–µ—Å—Ç–∞—Ü–∏—è *@
                            <div>
                                <label class="info-label">–¢–∏–ø —Å–¥–∞—á–∏</label>
                                <select name="CertificationType" class="form-control" required>
                                    @foreach (var item in allCertTypes)
                                    {
                                        <option value="@item.Value">@item.Text</option>
                                    }
                                </select>
                            </div>
                        </div>

                        @* –ö–Ω–æ–ø–∫–∞ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å *@
                        <div style="margin-top: 20px; text-align: right;">
                            <button type="submit" class="btn">
                                –°–æ—Ö—Ä–∞–Ω–∏—Ç—å
                            </button>
                        </div>
                        @Html.AntiForgeryToken()
                    </form>
                </div>
            </details>
        </div>
    }

    @* === 4. –°–ü–ò–°–û–ö –°–ï–ú–ï–°–¢–†–û–í –ò –î–ò–°–¶–ò–ü–õ–ò–ù (–ü–ª–∏—Ç–æ—á–Ω—ã–π —Å—Ç–∏–ª—å —Å–æ—Ö—Ä–∞–Ω–µ–Ω) === *@
    @if (!hasDisciplines)
    {
        <div class="card-style" style="text-align: center; color: var(--text-muted);">
            –í —ç—Ç–æ–º —É—á–µ–±–Ω–æ–º –ø–ª–∞–Ω–µ –ø–æ–∫–∞ –Ω–µ—Ç –¥–∏—Å—Ü–∏–ø–ª–∏–Ω.
        </div>
    }
    else
    {
        @foreach (var group in disciplinesBySemester)
        {
            <div class="direction-section" style="margin-bottom: 40px;">
                
                @* –ó–∞–≥–æ–ª–æ–≤–æ–∫ –°–µ–º–µ—Å—Ç—Ä–∞ *@
                <div class="direction-header-styled" style="display: flex; align-items: center; margin-bottom: 20px; padding-bottom: 10px; border-bottom: 2px solid var(--accent-dark);">
                    <span style="font-size: 1.5rem; margin-right: 10px; color: var(--accent-dark);">üìÖ</span>
                    <h3 style="margin: 0; font-size: 1.5rem; color: var(--accent-dark); font-weight: 700;">
                        –°–µ–º–µ—Å—Ç—Ä @group.Semester
                    </h3>
                </div>

                @* –°–ï–¢–ö–ê –î–ò–°–¶–ò–ü–õ–ò–ù (Program List) - –ö–õ–Æ–ß–ï–í–û–ï –ò–ó–ú–ï–ù–ï–ù–ò–ï: grid-auto-rows: 1fr *@
                <div class="program-list" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(240px, 1fr)); gap: 20px; grid-auto-rows: 1fr;">
                    @foreach (var discipline in (IEnumerable<dynamic>)group.Disciplines)
                    {
                        @* –ö–∞—Ä—Ç–æ—á–∫–∞ –¥–∏—Å—Ü–∏–ø–ª–∏–Ω—ã (Program Card) - –ö–õ–Æ–ß–ï–í–û–ï –ò–ó–ú–ï–ù–ï–ù–ò–ï: height: 100% *@
                        <div class="program-card card-style" style="padding: 15px; display: flex; flex-direction: column; justify-content: space-between; height: 100%;">
                            
                            @* –ù–∞–∑–≤–∞–Ω–∏–µ –¥–∏—Å—Ü–∏–ø–ª–∏–Ω—ã *@
                            <div style="margin-bottom: 10px;">
                                <h3 class="program-discipline-name" style="font-size: 1.1rem; line-height: 1.4; margin: 0; color: var(--text-main);">
                                    @discipline.Name
                                </h3>
                            </div>

                            @* –§—É—Ç–µ—Ä: –ê—Ç—Ç–µ—Å—Ç–∞—Ü–∏—è –∏ –£–¥–∞–ª–µ–Ω–∏–µ *@
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-top: auto; border-top: 1px dashed var(--border-dashed); padding-top: 8px;">
                                
                                @* –¢–∏–ø —Å–¥–∞—á–∏ (Badge) *@
                                <span class="badge-dark" style="background-color: var(--bg-element); color: var(--text-main); font-weight: 600; font-style: italic;">
                                    @discipline.CertificationType
                                </span>

                                @* –ö–Ω–æ–ø–∫–∞ —É–¥–∞–≤–ª–µ–Ω–∏—è (ADMIN) *@
                                @if (User.IsInRole("admin"))
                                {
                                    <form asp-controller="Curriculum" asp-action="Delete" method="post" 
                                          asp-route-curriculumId="@discipline.CurriculumId" 
                                          asp-route-specialtyId="@Model.Specialty.Id"
                                          style="margin: 0;">
                                        <button type="submit" class="btn-secondary" 
                                                style="border: none; background: transparent; font-size: 1.2rem; color: #dc3545; cursor: pointer; padding: 0;" 
                                                onclick="return confirm('–£–¥–∞–ª–∏—Ç—å @discipline.Name?')"
                                                title="–£–¥–∞–ª–∏—Ç—å">
                                            üóëÔ∏è
                                        </button>
                                    </form>
                                }
                            </div>
                        </div>
                    }
                </div>
            </div>
        }
    }
</div>