@model MyWebApp.Models.AcademicProgram

@{
    ViewData["Title"] = "–î–µ—Ç–∞–ª–∏ –ø—Ä–æ–≥—Ä–∞–º–º—ã";
    
    bool isAssignedTeacher = ViewBag.IsAssignedTeacher ?? false;
    bool isAdmin = ViewBag.IsAdmin ?? false; // –ò–ª–∏ User.IsInRole("admin")
    bool canEdit = ViewBag.CanEdit ?? false;
    bool isHeadOfDepartment = ViewBag.IsHeadOfDepartment ?? false;

    // --- –õ–û–ì–ò–ö–ê –û–¢–û–ë–†–ê–ñ–ï–ù–ò–Ø –ö–ù–û–ü–û–ö –†–ï–ó–û–õ–Æ–¶–ò–ò ---
    // –ö–Ω–æ–ø–∫–∏ –≤–∏–¥–Ω—ã, —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏:
    // 1. –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å - –∑–∞–≤. –∫–∞—Ñ–µ–¥—Ä–æ–π
    // 2. –°—Ç–∞—Ç—É—Å –ø—Ä–æ–≥—Ä–∞–º–º—ã "draft" (—á–µ—Ä–Ω–æ–≤–∏–∫) –ò–õ–ò "recheck" (–Ω–∞ –ø—Ä–æ–≤–µ—Ä–∫–µ)
    bool showResolutionButtons = isHeadOfDepartment 
                                 && (Model.Status == "draft" || Model.Status == "recheck");
}

<link rel="stylesheet" href="~/css/site.css" asp-append-version="true" />

<div class="container create-program-container">

    <div class="d-flex justify-content-between align-items-center mb-4">
        <a asp-action="Index" class="back-button">
            <i class="fas fa-arrow-left mr-2"></i> –ù–∞–∑–∞–¥ –∫ —Å–ø–∏—Å–∫—É
        </a>

        @* –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ —Ç–µ–∫—É—â–µ–≥–æ —Å—Ç–∞—Ç—É—Å–∞ *@
        <div>
            –°—Ç–∞—Ç—É—Å: 
            @if(Model.Status == "approved") 
            { 
                <span class="badge badge-success" style="font-size: 1em; padding: 10px;">‚úÖ –ü—Ä–∏–Ω—è—Ç–æ (Approved)</span> 
            }
            else if(Model.Status == "rejected") 
            { 
                <span class="badge badge-danger" style="font-size: 1em; padding: 10px;">‚ùå –û—Ç–∫–ª–æ–Ω–µ–Ω–æ (Rejected)</span> 
            }
            else if(Model.Status == "recheck") 
            { 
                <span class="badge badge-warning" style="font-size: 1em; padding: 10px;">‚ö†Ô∏è –¢—Ä–µ–±—É–µ—Ç –ø—Ä–æ–≤–µ—Ä–∫–∏</span> 
            }
            else 
            { 
                <span class="badge badge-secondary" style="font-size: 1em; padding: 10px;">üìù –ß–µ—Ä–Ω–æ–≤–∏–∫ (Draft)</span> 
            }
        </div>
    </div>

    <div class="main-card">
        <div style="text-align: center; margin-top: 20px;">
            <h2>–£—á–µ–±–Ω–∞—è –ø—Ä–æ–≥—Ä–∞–º–º–∞ ‚Äî –î–µ—Ç–∞–ª–∏</h2>
            
            <div class="d-flex justify-content-center align-items-center mb-4 flex-wrap">
                
                @* 1. –ö–ù–û–ü–ö–ê –°–ö–ê–ß–ê–¢–¨ *@
                <a asp-controller="AcademicProgram" 
                   asp-action="Download" 
                   asp-route-id="@Model.Id" 
                   class="btn btn-primary mr-3 mb-2">
                   ‚¨áÔ∏è –°–∫–∞—á–∞—Ç—å PDF
                </a>

                @* 2. –ö–ù–û–ü–ö–ê –†–ï–î–ê–ö–¢–ò–†–û–í–ê–¢–¨ *@
                @if (canEdit)
                {
                    <a asp-controller="AcademicProgram" 
                       asp-action="Edit" 
                       asp-route-id="@Model.Id" 
                       class="btn btn-warning mr-3 mb-2"> 
                        <i class="fas fa-edit mr-2"></i> –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å
                    </a>
                }

                @* 3. –ö–ù–û–ü–ö–ê –£–î–ê–õ–ò–¢–¨ *@
                @if (isAdmin)
                {
                    <form asp-action="Delete" asp-route-id="@Model.Id" method="post" class="mr-3 mb-2"
                          onsubmit="return confirm('–í–ù–ò–ú–ê–ù–ò–ï! –í—ã —É–≤–µ—Ä–µ–Ω—ã?');">
                        <button type="submit" class="btn btn-danger">
                            üóëÔ∏è –£–¥–∞–ª–∏—Ç—å
                        </button>
                    </form>
                }

                @* ========================================================== *@
                @* 4. –ö–ù–û–ü–ö–ò –ó–ê–í–ï–î–£–Æ–©–ï–ì–û –ö–ê–§–ï–î–†–û–ô *@
                @* –í–∏–¥–Ω—ã –¢–û–õ–¨–ö–û –µ—Å–ª–∏ —Å—Ç–∞—Ç—É—Å 'draft' –∏–ª–∏ 'recheck' *@
                @* ========================================================== *@
                @if (showResolutionButtons)
                {
                    <div class="border-left pl-3 ml-3 d-flex align-items-center bg-light p-2 rounded">
                        <span class="mr-2 font-weight-bold text-dark">–†–µ—à–µ–Ω–∏–µ:</span>
                        
                        @* –ö–Ω–æ–ø–∫–∞ –ü–†–ò–ù–Ø–¢–¨ *@
                        <form asp-action="ChangeStatus" method="post" class="mr-2">
                            <input type="hidden" name="id" value="@Model.Id" />
                            <input type="hidden" name="newStatus" value="approved" />
                            <button type="submit" class="btn btn-success font-weight-bold">
                                ‚úÖ –£—Ç–≤–µ—Ä–¥–∏—Ç—å
                            </button>
                        </form>

                        @* –ö–Ω–æ–ø–∫–∞ –û–¢–ö–õ–û–ù–ò–¢–¨ *@
                        <form asp-action="ChangeStatus" method="post">
                            <input type="hidden" name="id" value="@Model.Id" />
                            <input type="hidden" name="newStatus" value="rejected" />
                            <button type="submit" class="btn btn-outline-danger">
                                ‚ùå –û—Ç–∫–ª–æ–Ω–∏—Ç—å
                            </button>
                        </form>
                    </div>
                }
                @* ========================================================== *@

            </div>
        </div>

        <div class="card-body-custom">
            <div class="row mb-4">
                <div class="col-lg-8">
                    <div class="row">
                        <div class="col-md-8">
                            <label class="font-weight-bold">–ù–∞–∑–≤–∞–Ω–∏–µ –ø—Ä–æ–≥—Ä–∞–º–º—ã</label>
                            <div class="readonly-box">@Model.Name</div>
                        </div>

                        <div class="col-md-4">
                            <label class="font-weight-bold">–î–∏—Å—Ü–∏–ø–ª–∏–Ω–∞</label>
                            <div class="readonly-box">@Model.Discipline?.Name</div>
                        </div>
                    </div>

                    <div class="row mt-2">
                        <div class="col-md-8">
                            <label class="font-weight-bold">–°–ø–µ—Ü–∏–∞–ª—å–Ω–æ—Å—Ç—å</label>
                            <div class="readonly-box">@Model.Specialty?.Name</div>
                        </div>

                        <div class="col-md-4">
                            <label class="font-weight-bold">–ì–æ–¥ –Ω–∞—á–∞–ª–∞</label>
                            <div class="readonly-box">@Model.StartYear</div>
                        </div>
                    </div>
                </div>

                <div class="col-lg-4">
                    <div class="info-panel">
                        <div class="info-item">
                            <div class="info-label">–ù–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ</div>
                            <input type="text" class="readonly-box" readonly value="@Model.Specialty?.Direction" />
                        </div>
                        <div class="info-item mt-3">
                            <div class="info-label">–°—Ä–æ–∫ –æ–±—É—á–µ–Ω–∏—è</div>
                            <input type="text" class="readonly-box" readonly value="@Model.Specialty?.Duration" />
                        </div>
                        <div class="info-item mt-3">
                            <div class="info-label">–ö–≤–∞–ª–∏—Ñ–∏–∫–∞—Ü–∏—è</div>
                            <input type="text" class="readonly-box" readonly value="@Model.Specialty?.Qualification" />
                        </div>
                    </div>
                </div>
            </div>

            <hr />

            <h5 class="mt-4 mb-3" style="color: #333;">–ü—Ä–µ–ø–æ–¥–∞–≤–∞—Ç–µ–ª—å—Å–∫–∏–π —Å–æ—Å—Ç–∞–≤</h5>

            <table class="table table-bordered table-sm">
                <thead style="background: #f8f9fa;">
                    <tr>
                        <th>–ü—Ä–µ–ø–æ–¥–∞–≤–∞—Ç–µ–ª—å</th>
                        <th>–¢–∏–ø —É—á–∞—Å—Ç–∏—è</th>
                    </tr>
                </thead>
                <tbody>
                    @foreach (var dt in Model.Discipline.DisciplineTeachers)
                    {
                        <tr>
                            <td>@dt.Teacher.Surname @dt.Teacher.Name @dt.Teacher.Patronymic</td>
                            <td><span class="badge badge-light border p-2">@dt.ParticipationType</span></td>
                        </tr>
                    }
                </tbody>
            </table>

            <hr class="my-5" />
            <h4 style="color: var(--primary-color);">–£—á–µ–±–Ω—ã–π –ø–ª–∞–Ω –ø–æ —Å–µ–º–µ—Å—Ç—Ä–∞–º</h4>

            <div id="semestersContainer">
                @foreach (var wl in Model.WorkLoads.OrderBy(w => w.Semester))
                {
                    <div class="semester-card mb-4">
                        <div class="semester-header-custom">
                            <h5 class="text-primary font-weight-bold mb-0">
                                –°–µ–º–µ—Å—Ç—Ä @wl.Semester
                            </h5>
                        </div>
                        <div class="workload-grid mt-3">
                            <div class="workload-item">
                                <label>–õ–µ–∫—Ü–∏–∏</label>
                                <div class="readonly-box">@wl.Lectures</div>
                            </div>
                            <div class="workload-item">
                                <label>–õ–∞–±.</label>
                                <div class="readonly-box">@wl.Labs</div>
                            </div>
                            <div class="workload-item">
                                <label>–ü—Ä–∞–∫—Ç.</label>
                                <div class="readonly-box">@wl.SelfStudy</div>
                            </div>
                            <div class="workload-item">
                                <label>–°–†–°</label>
                                <div class="readonly-box">@wl.IntermediateAssessment</div>
                            </div>
                            <div class="workload-item">
                                <label>–ê—Ç—Ç–µ—Å—Ç–∞—Ü–∏—è</label>
                                <div class="readonly-box">@wl.AssessmentType</div>
                            </div>
                        </div>

                        <div class="sections-wrapper mt-4">
                            <h6 class="text-secondary">–†–∞–∑–¥–µ–ª—ã –¥–∏—Å—Ü–∏–ø–ª–∏–Ω—ã:</h6>
                            <table class="table table-bordered table-sm table-custom">
                                <thead>
                                    <tr>
                                        <th style="width: 50px;">#</th>
                                        <th style="width: 30%;">–ù–∞–∑–≤–∞–Ω–∏–µ —Ä–∞–∑–¥–µ–ª–∞</th>
                                        <th style="width: 40%;">–ö—Ä–∞—Ç–∫–æ–µ —Å–æ–¥–µ—Ä–∂–∞–Ω–∏–µ</th>
                                        <th>–õ–µ–∫.</th>
                                        <th>–õ–∞–±.</th>
                                        <th>–°–µ–º.</th>
                                        <th>–°–†–°</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    @foreach (var s in wl.Sections.OrderBy(s => s.Index))
                                    {
                                        <tr>
                                            <td>@s.Index</td>
                                            <td>@s.Name</td>
                                            <td>@s.Description</td>
                                            <td>@s.LectureHours</td>
                                            <td>@s.LabHours</td>
                                            <td>@s.SeminarHours</td>
                                            <td>@s.SelfStudyHours</td>
                                        </tr>
                                    }
                                </tbody>
                            </table>
                        </div>
                    </div>
                }
            </div>

            <hr class="my-5" />

            <h4 style="color: var(--primary-color); margin-bottom: 20px;">–ú–µ—Ç–æ–¥–∏—á–µ—Å–∫–∏–µ –º–∞—Ç–µ—Ä–∏–∞–ª—ã</h4>

            <div class="row">
                <div class="col-md-6 mb-4">
                    <label class="methodical-label">–¶–µ–ª–∏ –∏ –∑–∞–¥–∞—á–∏</label>
                    <div class="readonly-box" style="white-space:pre-line;">@Model.Goals</div>
                </div>

                <div class="col-md-6 mb-4">
                    <label class="methodical-label">–ö–æ–º–ø–µ—Ç–µ–Ω—Ü–∏–∏</label>
                    <div class="readonly-box" style="white-space:pre-line;">@Model.Competencies</div>
                </div>

                <div class="col-md-6 mb-4">
                    <label class="methodical-label">–¢—Ä–µ–±–æ–≤–∞–Ω–∏—è</label>
                    <div class="readonly-box" style="white-space:pre-line;">@Model.Requirements</div>
                </div>

                <div class="col-md-6 mb-4">
                    <label class="methodical-label">–ú–µ—Å—Ç–æ –¥–∏—Å—Ü–∏–ø–ª–∏–Ω—ã</label>
                    <div class="readonly-box" style="white-space:pre-line;">@Model.DisciplinePosition</div>
                </div>

                <div class="col-md-6 mb-4">
                    <label class="methodical-label">–õ–∏—Ç–µ—Ä–∞—Ç—É—Ä–∞</label>
                    <div class="readonly-box" style="white-space:pre-line;">@Model.Literature</div>
                </div>
            </div>

        </div>
    </div>

</div>