@model Department
@using Microsoft.EntityFrameworkCore
@inject MyWebApp.Data.ApplicationDbContext Context

<link rel="stylesheet" href="~/css/site.css" asp-append-version="true" />

<div class="container department-page">
    
    <a href="/Departments?facultyId=@Model.FacultyId" class="back-button">
        <span class="back-icon">←</span> Назад к списку кафедр
    </a>

    <h2 class="faculty-title">@Model.Name</h2>

    <div class="faculty-head" style="text-align:center; margin-bottom: 25px;">
        Заведующий: 
        <b>@Model.Head?.Surname @Model.Head?.Name @Model.Head?.Patronymic</b>
    </div>

    @{
        // 1. Получаем текущего пользователя по имени (ФИО)
        var currentUser = await Context.Users
            .FirstOrDefaultAsync(u => (u.Surname + " " + u.Name) == User.Identity.Name);

        // 2. Проверяем, является ли текущий пользователь заведующим данной кафедрой
        var isHead = currentUser != null && Model.Head != null && currentUser.Login == Model.Head.Login;
        
        // 3. Получаем список всех дисциплин для формы добавления
        var disciplines = await Context.Disciplines.ToListAsync();
    }

    <div class="faculty-list">

        @foreach (var ta in Model.TeacherAssignments)
        {
            var teacher = ta.Teacher;

            <div class="teacher-card">

                <div class="teacher-info">

                    <div class="teacher-row">
                        <div class="teacher-name">
                            @teacher.Surname @teacher.Name @teacher.Patronymic
                        </div>
                    </div>

                    <div>
                        <strong>Дисциплины:</strong>

                        <ul class="discipline-list">
                            @foreach (var dt in teacher.DisciplineTeachers)
                            {
                                <li class="discipline-item">
                                    <span>
                                        @dt.Discipline.Name — <b>@dt.ParticipationType</b>
                                    </span>

                                    @* Отображаем кнопку "Удалить" только для заведующего кафедрой *@
                                    @if (User.Identity.IsAuthenticated && isHead)
                                    {
                                        <form method="post" asp-controller="Teachers" asp-action="RemoveDiscipline">
                                            <input type="hidden" name="disciplineTeacherId" value="@dt.Id" />
                                            <input type="hidden" name="departmentId" value="@Model.Id" />
                                            <button type="submit" class="btn delete-btn">Удалить</button>
                                        </form>
                                    }
                                </li>
                            }
                        </ul>
                    </div>

                    @* Блок для добавления дисциплины (доступен только заведующему) *@
                    @if (User.Identity.IsAuthenticated && isHead)
                    {
                        <button type="button" class="btn add-button"
                                onclick="toggleForm(@teacher.Id, this)">
                            Добавить дисциплину
                        </button>

                        <div id="form-@teacher.Id" class="add-discipline-form" style="display:none;">

                            <form method="post" asp-controller="Teachers" asp-action="AssignDiscipline">
                                <input type="hidden" name="teacherId" value="@teacher.Id" />
                                <input type="hidden" name="departmentId" value="@Model.Id" />

                                <select name="disciplineId" required>
                                    @foreach (var d in disciplines)
                                    {
                                        <option value="@d.Id">@d.Name</option>
                                    }
                                </select>

                                <select name="participationType" required>
                                    <option value="Лекции">Лекции</option>
                                    <option value="Семинары">Семинары</option>
                                    <option value="Лабораторные">Лабораторные</option>
                                </select>

                                <button type="submit" class="btn save-button">Сохранить</button>
                            </form>
                        </div>
                    }

                </div>
            </div>
        }

    </div>
</div>
<script>
    function toggleForm(id, button) {
        const form = document.getElementById("form-" + id);

        form.style.display = "block";   // ПОКАЗЫВАЕМ ФОРМУ
        button.style.display = "none";  // СКРЫВАЕМ КНОПКУ "Добавить"
    }
</script>