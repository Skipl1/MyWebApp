@model Department
@using Microsoft.EntityFrameworkCore
@inject MyWebApp.Data.ApplicationDbContext Context

<link rel="stylesheet" href="~/css/site.css" />

<div class="container department-page">
    
    <a href="/Departments?facultyId=@Model.FacultyId" class="back-button">
        <span class="back-icon">‚Üê</span> –ù–∞–∑–∞–¥ –∫ —Å–ø–∏—Å–∫—É –∫–∞—Ñ–µ–¥—Ä
    </a>

    <h2 class="faculty-title">@Model.Name</h2>

    <div class="faculty-head" style="text-align:center; margin-bottom: 25px;">
        –ó–∞–≤–µ–¥—É—é—â–∏–π: 
        <b>@Model.Head?.Surname @Model.Head?.Name @Model.Head?.Patronymic</b>
    </div>

    @{
        // 1. –ü–æ–ª—É—á–∞–µ–º —Ç–µ–∫—É—â–µ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –ø–æ –∏–º–µ–Ω–∏ (–§–ò–û)
        var currentUser = await Context.Users
            .FirstOrDefaultAsync(u => (u.Surname + " " + u.Name) == User.Identity.Name);

        // 2. –ü—Ä–æ–≤–µ—Ä—è–µ–º, —è–≤–ª—è–µ—Ç—Å—è –ª–∏ —Ç–µ–∫—É—â–∏–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∑–∞–≤–µ–¥—É—é—â–∏–º –¥–∞–Ω–Ω–æ–π –∫–∞—Ñ–µ–¥—Ä–æ–π
        var isHead = currentUser != null && Model.Head != null && currentUser.Login == Model.Head.Login;
        
        // 3. –ü–æ–ª—É—á–∞–µ–º —Å–ø–∏—Å–æ–∫ –≤—Å–µ—Ö –¥–∏—Å—Ü–∏–ø–ª–∏–Ω –¥–ª—è —Ñ–æ—Ä–º—ã –¥–æ–±–∞–≤–ª–µ–Ω–∏—è
        var disciplines = await Context.Disciplines.ToListAsync();
    }

    <div class="faculty-list">

        @foreach (var ta in Model.TeacherAssignments)
        {
            var teacher = ta.Teacher;

            <div class="teacher-card">

                <div class="teacher-info">

                    <div class="teacher-row">
                        <div class="teacher-name">
                            üë§ @teacher.Surname @teacher.Name @teacher.Patronymic
                        </div>
                    </div>

                    <div>
                        <strong>üìö –î–∏—Å—Ü–∏–ø–ª–∏–Ω—ã:</strong>

                        <ul class="discipline-list">
                            @foreach (var dt in teacher.DisciplineTeachers)
                            {
                                <li class="discipline-item">
                                    <span>
                                        @dt.Discipline.Name ‚Äî <b>@dt.ParticipationType</b>
                                    </span>

                                    @* –û—Ç–æ–±—Ä–∞–∂–∞–µ–º –∫–Ω–æ–ø–∫—É "–£–¥–∞–ª–∏—Ç—å" —Ç–æ–ª—å–∫–æ –¥–ª—è –∑–∞–≤–µ–¥—É—é—â–µ–≥–æ –∫–∞—Ñ–µ–¥—Ä–æ–π *@
                                    @if (User.Identity.IsAuthenticated && isHead)
                                    {
                                        <form method="post" asp-controller="Teachers" asp-action="RemoveDiscipline">
                                            <input type="hidden" name="disciplineTeacherId" value="@dt.Id" />
                                            <input type="hidden" name="departmentId" value="@Model.Id" />
                                            <button type="submit" class="btn delete-btn">–£–¥–∞–ª–∏—Ç—å</button>
                                        </form>
                                    }
                                </li>
                            }
                        </ul>
                    </div>

                    @* –ë–ª–æ–∫ –¥–ª—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –¥–∏—Å—Ü–∏–ø–ª–∏–Ω—ã (–¥–æ—Å—Ç—É–ø–µ–Ω —Ç–æ–ª—å–∫–æ –∑–∞–≤–µ–¥—É—é—â–µ–º—É) *@
                    @if (User.Identity.IsAuthenticated && isHead)
                    {
                        <button type="button" class="btn add-button"
                                onclick="toggleForm(@teacher.Id, this)">
                            –î–æ–±–∞–≤–∏—Ç—å –¥–∏—Å—Ü–∏–ø–ª–∏–Ω—É
                        </button>

                        <div id="form-@teacher.Id" class="add-discipline-form" style="display:none;">

                            <form method="post" asp-controller="Teachers" asp-action="AssignDiscipline">
                                <input type="hidden" name="teacherId" value="@teacher.Id" />
                                <input type="hidden" name="departmentId" value="@Model.Id" />

                                <select name="disciplineId" required>
                                    @foreach (var d in disciplines)
                                    {
                                        <option value="@d.Id">@d.Name</option>
                                    }
                                </select>

                                <select name="participationType" required>
                                    <option value="–õ–µ–∫—Ü–∏–∏">–õ–µ–∫—Ü–∏–∏</option>
                                    <option value="–°–µ–º–∏–Ω–∞—Ä—ã">–°–µ–º–∏–Ω–∞—Ä—ã</option>
                                    <option value="–õ–∞–±–æ—Ä–∞—Ç–æ—Ä–Ω—ã–µ">–õ–∞–±–æ—Ä–∞—Ç–æ—Ä–Ω—ã–µ</option>
                                </select>

                                <button type="submit" class="btn save-button">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
                            </form>
                        </div>
                    }

                </div>
            </div>
        }

    </div>
</div>
<script>
    function toggleForm(id, button) {
        const form = document.getElementById("form-" + id);

        form.style.display = "block";   // –ü–û–ö–ê–ó–´–í–ê–ï–ú –§–û–†–ú–£
        button.style.display = "none";  // –°–ö–†–´–í–ê–ï–ú –ö–ù–û–ü–ö–£ "–î–æ–±–∞–≤–∏—Ç—å"
    }
</script>